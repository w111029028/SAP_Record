*&---------------------------------------------------------------------*
*& INCLUDE          ZFI007F1_IS_COMPANY
*&---------------------------------------------------------------------*

DATA:
  lv_fiscper   TYPE rwcoom-fiscper,
  lt_bukrs     TYPE acdoca-rbukrs OCCURS 0,
  lv_bukrs     TYPE acdoca-rbukrs,
  lv_ksl       TYPE acdoca-ksl,
  lv_aggregate TYPE acdoca-ksl,
  lv_income TYPE acdoca-ksl,
  BEGIN OF lt_rbusa OCCURS 0,
    bukrs       TYPE acdoca-rbukrs,
    prctr       TYPE acdoca-prctr,
    rbusa       TYPE acdoca-rbusa,
    description TYPE string,
  END OF lt_rbusa,
  ls_rbusa LIKE lt_rbusa,
  BEGIN OF lt_racct OCCURS 0,
    racct_low  TYPE acdoca-racct,
    racct_high TYPE acdoca-racct,
    description TYPE string,
  END OF lt_racct,
  ls_racct LIKE lt_racct.

RANGES: lr_racct FOR acdoca-racct,
  gr_income_racct FOR acdoca-racct.

FORM create_is_company_sheet.
  PERFORM set_data.

  LOOP AT lt_bukrs ASSIGNING FIELD-SYMBOL(<fs_bukrs>).
    CALL METHOD OF lo_application 'Sheets' = lo_worksheets .
    CALL METHOD OF lo_worksheets 'Add' = lo_worksheet1.
    CALL METHOD OF lo_worksheet1 'Activate'.

    CASE <fs_bukrs>.
      WHEN '1000'.
        SET PROPERTY OF lo_worksheet1 'Name' = 'IS-IT'.
      WHEN '1100'.
        SET PROPERTY OF lo_worksheet1 'Name' = 'IS-瑞鈦'.
      WHEN '2000'.
        SET PROPERTY OF lo_worksheet1 'Name' = 'IS-Aoltec'.
*      WHEN '3000'.
*        SET PROPERTY OF lo_worksheet1 'Name' = 'IS-EG'.
    ENDCASE.

    CALL METHOD OF lo_application 'Worksheets' = lo_worksheet1 EXPORTING #1 = 1.
    CALL METHOD OF lo_worksheet1 'Activate'.

    PERFORM set_layout.

    cell:
      lo_worksheet1 1 1 '科目' 3 '0',
      lo_worksheet1 1 2 '合計' 3 '0'.

    DATA: lv_index_row   TYPE i,
          lv_index_col   TYPE i,
          lv_description TYPE string.
    lv_index_row = 2.
    LOOP AT lt_racct ASSIGNING FIELD-SYMBOL(<fs_racct>).
      CLEAR: lr_racct, lr_racct[].

      IF <fs_racct>-racct_high IS INITIAL.
        lr_racct-sign = 'I'.
        lr_racct-option = 'EQ'.
        lr_racct-low = <fs_racct>-racct_low.
        APPEND lr_racct.
        APPEND lr_racct TO gr_income_racct.
        lv_description = <fs_racct>-description && '('
          && <fs_racct>-racct_low
          && ')'.
      ELSEIF <fs_racct>-racct_high IS NOT INITIAL.
        lr_racct-sign = 'I'.
        lr_racct-option = 'BT'.
        lr_racct-low = <fs_racct>-racct_low.
        lr_racct-high = <fs_racct>-racct_high.
        APPEND lr_racct.
        APPEND lr_racct TO gr_income_racct.
        lv_description = <fs_racct>-description && '('
          && <fs_racct>-racct_low && '-' && <fs_racct>-racct_high
          && ')'.
      ENDIF.
      cell: lo_worksheet1 lv_index_row 1 lv_description 3 '0'.

      lv_index_col = 3.
      CLEAR: lv_aggregate, lv_description.
      LOOP AT lt_rbusa ASSIGNING FIELD-SYMBOL(<fs_rbusa>)
        WHERE bukrs EQ <fs_bukrs>.
        CLEAR: lv_ksl.
        SELECT
          *
        FROM acdoca
        INTO TABLE @DATA(lt_acdoca)
        WHERE fiscyearper EQ @lv_fiscper
          AND xreversing EQ ''
          AND xreversed EQ ''
          AND xtruerev EQ ''
          AND prctr EQ @<fs_rbusa>-prctr
          AND rbusa EQ @<fs_rbusa>-rbusa
          AND racct IN @lr_racct
          AND rbukrs EQ @<fs_bukrs>.

        DELETE lt_acdoca WHERE ksl EQ 0.

        LOOP AT lt_acdoca ASSIGNING FIELD-SYMBOL(<fs_acdoca>).
          IF <fs_acdoca>-rkcur EQ 'TWD'.
            <fs_acdoca>-ksl = |{ <fs_acdoca>-ksl CURRENCY = <fs_acdoca>-rkcur }|.
          ENDIF.
          IF <fs_bukrs> NE '2000'.
            lv_ksl = lv_ksl + <fs_acdoca>-ksl.
          ELSEIF <fs_bukrs> EQ '2000'.
            <fs_acdoca>-wsl = |{ <fs_acdoca>-wsl CURRENCY = <fs_acdoca>-rwcur }|.
            lv_ksl = lv_ksl + <fs_acdoca>-wsl.
          ENDIF.
        ENDLOOP.
        lv_ksl = lv_ksl * -1.

        cell lo_worksheet1 1 lv_index_col <fs_rbusa>-description 3 '0'.
        IF <fs_bukrs> NE '2000'.
          cell lo_worksheet1 lv_index_row lv_index_col lv_ksl 3 'TWD'.
        ELSEIF <fs_bukrs> EQ '2000'.
          cell lo_worksheet1 lv_index_row lv_index_col lv_ksl 3 'USD'.
        ENDIF.
        lv_aggregate = lv_aggregate + lv_ksl.
        lv_index_col = lv_index_col + 1.
      ENDLOOP.
      CLEAR: lv_ksl.
      IF <fs_bukrs> NE '2000'.
        cell: lo_worksheet1 lv_index_row 2 lv_aggregate 3 'TWD'.
      ELSEIF <fs_bukrs> EQ '2000'.
        cell: lo_worksheet1 lv_index_row 2 lv_aggregate 3 'USD'.
      ENDIF.

      CLEAR: lv_aggregate.
      lv_index_row = lv_index_row + 1.
    ENDLOOP.

    " 計算營業收入(總計)
    lv_index_col = 3.
    CLEAR: lv_aggregate, lv_description.
    cell: lo_worksheet1 lv_index_row 1 '營業收入' 3 '0'.
    LOOP AT lt_rbusa ASSIGNING FIELD-SYMBOL(<fs_rbusa_income>)
      WHERE bukrs EQ <fs_bukrs>.
      CLEAR: lv_ksl.
      SELECT
        *
      FROM acdoca
      INTO TABLE @DATA(lt_acdoca_income)
      WHERE fiscyearper EQ @lv_fiscper
        AND xreversing EQ ''
        AND xreversed EQ ''
        AND xtruerev EQ ''
        AND prctr EQ @<fs_rbusa_income>-prctr
        AND rbusa EQ @<fs_rbusa_income>-rbusa
        AND racct IN @gr_income_racct
        AND rbukrs EQ @<fs_bukrs>.

      DELETE lt_acdoca_income WHERE ksl EQ 0.

      LOOP AT lt_acdoca_income ASSIGNING FIELD-SYMBOL(<fs_acdoca_income>).
        IF <fs_acdoca_income>-rkcur EQ 'TWD'.
          <fs_acdoca_income>-ksl = |{ <fs_acdoca_income>-ksl CURRENCY = <fs_acdoca_income>-rkcur }|.
        ENDIF.
        IF <fs_bukrs> NE '2000'.
          lv_ksl = lv_ksl + <fs_acdoca_income>-ksl.
        ELSEIF <fs_bukrs> EQ '2000'.
          <fs_acdoca_income>-wsl = |{ <fs_acdoca_income>-wsl CURRENCY = <fs_acdoca_income>-rwcur }|.
          lv_ksl = lv_ksl + <fs_acdoca_income>-wsl.
        ENDIF.
      ENDLOOP.
      lv_ksl = lv_ksl * -1.
      IF <fs_bukrs> NE '2000'.
        cell: lo_worksheet1 lv_index_row lv_index_col lv_ksl 3 'TWD'.
      ELSEIF <fs_bukrs> EQ '2000'.
        cell: lo_worksheet1 lv_index_row lv_index_col lv_ksl 3 'USD'.
      ENDIF.
      CASE <fs_rbusa_income>-rbusa.
        WHEN '1001'.
          gs_each_business-income_1001 = lv_ksl.
        WHEN '1002'.
          gs_each_business-income_1002 = lv_ksl.
        WHEN '1003'.
          gs_each_business-income_1003 = lv_ksl.
        WHEN '1004'.
          gs_each_business-income_1004 = lv_ksl.
        WHEN '1005'.
          gs_each_business-income_1005 = lv_ksl.
        WHEN '1006'.
          gs_each_business-income_1006 = lv_ksl.
        WHEN '1007'.
          gs_each_business-income_1007 = lv_ksl.
        WHEN '1011'.
          gs_each_business-income_1011 = lv_ksl.
        WHEN OTHERS.
          IF <fs_rbusa_income>-bukrs EQ '1100'.
            gs_each_business-income_1100 = lv_ksl.
          ENDIF.
      ENDCASE.
      lv_aggregate = lv_aggregate + lv_ksl.
      lv_index_col = lv_index_col + 1.
    ENDLOOP.
    IF <fs_bukrs> NE '2000'.
      cell: lo_worksheet1 lv_index_row 2 lv_aggregate 3 'TWD'.
    ELSEIF <fs_bukrs> EQ '2000'.
      cell: lo_worksheet1 lv_index_row 2 lv_aggregate 3 'USD'.
    ENDIF.

    FREE gr_income_racct.
  ENDLOOP.

  SELECT
        *
      FROM acdoca
      INTO @DATA(gs_reversing)
      WHERE gjahr EQ @lv_fiscper+0(4)
        AND poper EQ @lv_fiscper+4(3)
        AND rbukrs EQ '1000'
        AND ( racct EQ '0041110001'
         OR racct EQ '0041700001'
         OR racct EQ '0041700002'
         OR racct EQ '0041900001'
         OR racct EQ '0041900002' )
        AND rassc EQ '001100'.
        gs_reversing-ksl = |{ gs_reversing-ksl CURRENCY  = gs_reversing-rkcur }|.
        IF gs_reversing-rbusa EQ '1001' OR gs_reversing-rbusa EQ '1004'.
          gs_each_business-income_1001 = gs_each_business-income_1001 + gs_reversing-ksl.
        ELSEIF gs_reversing-rbusa EQ '1003'.
          gs_each_business-income_1003 = gs_each_business-income_1003 + gs_reversing-ksl.
        ELSEIF gs_reversing-rbusa EQ '1005'.
          gs_each_business-income_1005 = gs_each_business-income_1005 + gs_reversing-ksl.
        ELSEIF gs_reversing-rbusa EQ '1006'.
          gs_each_business-income_1006 = gs_each_business-income_1006 + gs_reversing-ksl.
        ELSEIF gs_reversing-rbusa EQ '1007'.
          gs_each_business-income_1007 = gs_each_business-income_1007 + gs_reversing-ksl.
        ENDIF.
      ENDSELECT.
  gs_each_business-income_1001 = gs_each_business-income_1001 + gs_each_business-income_1004.
  CLEAR: gs_each_business-income_1004.
  " 醫療金額 = 總營收 - 其他事業處
  gs_each_business-income_1002 = gs_each_business-total_income
    - gs_each_business-income_1001 - gs_each_business-income_1003
    - gs_each_business-income_1004 - gs_each_business-income_1005
    - gs_each_business-income_1006 - gs_each_business-income_1007
    - gs_each_business-income_1100.

  gs_each_business-fiscper = p_gjahr  && p_poper.
  MODIFY zfi007t3 FROM gs_each_business.
  COMMIT WORK.
ENDFORM.

FORM set_layout.
  CALL METHOD OF lo_worksheet1 'Range' = lo_cell
      EXPORTING
        #1 = 'A1'
        #2 = 'A1'.
  GET PROPERTY OF lo_cell 'COLUMNS' = lo_col.
  SET PROPERTY OF lo_col 'COLUMNWIDTH' = '35.00'.

  CALL METHOD OF lo_worksheet1 'Range' = lo_cell
      EXPORTING
        #1 = 'B1'
        #2 = 'B1'.
  GET PROPERTY OF lo_cell 'COLUMNS' = lo_col.
  SET PROPERTY OF lo_col 'COLUMNWIDTH' = '14.00'.

  CALL METHOD OF lo_worksheet1 'Range' = lo_cell
      EXPORTING
        #1 = 'C1'
        #2 = 'C1'.
  GET PROPERTY OF lo_cell 'COLUMNS' = lo_col.
  SET PROPERTY OF lo_col 'COLUMNWIDTH' = '14.00'.

  CALL METHOD OF lo_worksheet1 'Range' = lo_cell
      EXPORTING
        #1 = 'D1'
        #2 = 'D1'.
  GET PROPERTY OF lo_cell 'COLUMNS' = lo_col.
  SET PROPERTY OF lo_col 'COLUMNWIDTH' = '14.00'.

  CALL METHOD OF lo_worksheet1 'Range' = lo_cell
      EXPORTING
        #1 = 'E1'
        #2 = 'E1'.
  GET PROPERTY OF lo_cell 'COLUMNS' = lo_col.
  SET PROPERTY OF lo_col 'COLUMNWIDTH' = '14.00'.

  CALL METHOD OF lo_worksheet1 'Range' = lo_cell
      EXPORTING
        #1 = 'F1'
        #2 = 'F1'.
  GET PROPERTY OF lo_cell 'COLUMNS' = lo_col.
  SET PROPERTY OF lo_col 'COLUMNWIDTH' = '14.00'.

  CALL METHOD OF lo_worksheet1 'Range' = lo_cell
      EXPORTING
        #1 = 'G1'
        #2 = 'G1'.
  GET PROPERTY OF lo_cell 'COLUMNS' = lo_col.
  SET PROPERTY OF lo_col 'COLUMNWIDTH' = '14.00'.

  CALL METHOD OF lo_worksheet1 'Range' = lo_cell
      EXPORTING
        #1 = 'H1'
        #2 = 'H1'.
  GET PROPERTY OF lo_cell 'COLUMNS' = lo_col.
  SET PROPERTY OF lo_col 'COLUMNWIDTH' = '14.00'.

  CALL METHOD OF lo_worksheet1 'Range' = lo_cell
      EXPORTING
        #1 = 'I1'
        #2 = 'I1'.
  GET PROPERTY OF lo_cell 'COLUMNS' = lo_col.
  SET PROPERTY OF lo_col 'COLUMNWIDTH' = '14.00'.

  CALL METHOD OF lo_worksheet1 'Range' = lo_cell
      EXPORTING
        #1 = 'J1'
        #2 = 'J1'.
  GET PROPERTY OF lo_cell 'COLUMNS' = lo_col.
  SET PROPERTY OF lo_col 'COLUMNWIDTH' = '14.00'.

  CALL METHOD OF lo_worksheet1 'Range' = lo_cell
      EXPORTING
        #1 = 'K1'
        #2 = 'K1'.
  GET PROPERTY OF lo_cell 'COLUMNS' = lo_col.
  SET PROPERTY OF lo_col 'COLUMNWIDTH' = '14.00'.
ENDFORM.

FORM set_data.
  lv_fiscper = p_gjahr && p_poper.

  lv_bukrs = '1000'.
  APPEND lv_bukrs TO lt_bukrs.

  lv_bukrs = '1100'.
  APPEND lv_bukrs TO lt_bukrs.

  lv_bukrs = '2000'.
  APPEND lv_bukrs TO lt_bukrs.

*  lv_bukrs = '3000'.
*  APPEND lv_bukrs TO lt_bukrs.

  ls_racct-racct_low = '0041110001'.
  ls_racct-racct_high = '0041119999'.
  ls_racct-description = '銷貨收入總額'.
  APPEND ls_racct TO lt_racct.
  CLEAR ls_racct.

  ls_racct-racct_low = '0041700001'.
  ls_racct-description = '銷售退回'.
  APPEND ls_racct TO lt_racct.
  CLEAR ls_racct.

  ls_racct-racct_low = '0041700002'.
  ls_racct-description = '銷售退回-GL'.
  APPEND ls_racct TO lt_racct.
  CLEAR ls_racct.

  ls_racct-racct_low = '0041900001'.
  ls_racct-racct_high = '0041900002'.
  ls_racct-description = '銷貨折讓'.
  APPEND ls_racct TO lt_racct.
  CLEAR ls_racct.

  ls_rbusa-bukrs = '1000'.
  ls_rbusa-prctr = '20E00'.
  ls_rbusa-rbusa = '1002'.
  ls_rbusa-description = '醫療'.
  APPEND ls_rbusa TO lt_rbusa.
  CLEAR: ls_rbusa.

  ls_rbusa-bukrs = '1000'.
  ls_rbusa-prctr = '20T00'.
  ls_rbusa-rbusa = '1003'.
  ls_rbusa-description = '微波'.
  APPEND ls_rbusa TO lt_rbusa.
  CLEAR: ls_rbusa.

  ls_rbusa-bukrs = '1000'.
  ls_rbusa-prctr = '20S00'.
  ls_rbusa-rbusa = '1001'.
  ls_rbusa-description = '扣一'.
  APPEND ls_rbusa TO lt_rbusa.
  CLEAR: ls_rbusa.

  ls_rbusa-bukrs = '1000'.
  ls_rbusa-prctr = '20Q00'.
  ls_rbusa-rbusa = '1004'.
  ls_rbusa-description = '扣二'.
  APPEND ls_rbusa TO lt_rbusa.
  CLEAR: ls_rbusa.

  ls_rbusa-bukrs = '1000'.
  ls_rbusa-prctr = '20B00'.
  ls_rbusa-rbusa = '1005'.
  ls_rbusa-description = '植入物'.
  APPEND ls_rbusa TO lt_rbusa.
  CLEAR: ls_rbusa.

  ls_rbusa-bukrs = '1000'.
  ls_rbusa-prctr = '20R00'.
  ls_rbusa-rbusa = '1006'.
  ls_rbusa-description = 'SFR'.
  APPEND ls_rbusa TO lt_rbusa.
  CLEAR: ls_rbusa.

  ls_rbusa-bukrs = '1000'.
  ls_rbusa-prctr = '20D00'.
  ls_rbusa-rbusa = '1007'.
  ls_rbusa-description = '牙科'.
  APPEND ls_rbusa TO lt_rbusa.
  CLEAR: ls_rbusa.

  ls_rbusa-bukrs = '1000'.
  ls_rbusa-prctr = '20M00'.
  ls_rbusa-rbusa = '1011'.
  ls_rbusa-description = 'MIM'.
  APPEND ls_rbusa TO lt_rbusa.
  CLEAR: ls_rbusa.

  ls_rbusa-bukrs = '1000'.
  ls_rbusa-prctr = '10100'.
  ls_rbusa-description = '集團管理共用'.
  APPEND ls_rbusa TO lt_rbusa.
  CLEAR: ls_rbusa.

  ls_rbusa-bukrs = '1100'.
  ls_rbusa-prctr = '0000011000'.
  ls_rbusa-description = '瑞鈦'.
  APPEND ls_rbusa TO lt_rbusa.
  CLEAR: ls_rbusa.

  ls_rbusa-bukrs = '2000'.
  ls_rbusa-prctr = '20E00'.
  ls_rbusa-rbusa = '2002'.
  ls_rbusa-description = '醫療'.
  APPEND ls_rbusa TO lt_rbusa.
  CLEAR: ls_rbusa.

  ls_rbusa-bukrs = '2000'.
  ls_rbusa-prctr = '20T00'.
  ls_rbusa-rbusa = '2003'.
  ls_rbusa-description = '微波'.
  APPEND ls_rbusa TO lt_rbusa.
  CLEAR: ls_rbusa.

  ls_rbusa-bukrs = '2000'.
  ls_rbusa-prctr = '20S00'.
  ls_rbusa-rbusa = '2001'.
  ls_rbusa-description = '扣一'.
  APPEND ls_rbusa TO lt_rbusa.
  CLEAR: ls_rbusa.

  ls_rbusa-bukrs = '2000'.
  ls_rbusa-prctr = '20Q00'.
  ls_rbusa-rbusa = '2004'.
  ls_rbusa-description = '扣二'.
  APPEND ls_rbusa TO lt_rbusa.
  CLEAR: ls_rbusa.

  ls_rbusa-bukrs = '2000'.
  ls_rbusa-prctr = '20B00'.
  ls_rbusa-rbusa = '2005'.
  ls_rbusa-description = '植入物'.
  APPEND ls_rbusa TO lt_rbusa.
  CLEAR: ls_rbusa.

  ls_rbusa-bukrs = '2000'.
  ls_rbusa-prctr = '20R00'.
  ls_rbusa-rbusa = '2006'.
  ls_rbusa-description = 'SFR'.
  APPEND ls_rbusa TO lt_rbusa.
  CLEAR: ls_rbusa.

  ls_rbusa-bukrs = '2000'.
  ls_rbusa-prctr = '20D00'.
  ls_rbusa-rbusa = '2007'.
  ls_rbusa-description = '牙科'.
  APPEND ls_rbusa TO lt_rbusa.
  CLEAR: ls_rbusa.

  ls_rbusa-bukrs = '2000'.
  ls_rbusa-prctr = '20M00'.
  ls_rbusa-rbusa = '2011'.
  ls_rbusa-description = 'MIM'.
  APPEND ls_rbusa TO lt_rbusa.
  CLEAR: ls_rbusa.

  ls_rbusa-bukrs = '2000'.
  ls_rbusa-prctr = '0000010100'.
  ls_rbusa-description = '集團管理共用'.
  APPEND ls_rbusa TO lt_rbusa.
  CLEAR: ls_rbusa.
ENDFORM.
